import { urldecode } from 'wepy-urlencode';

var md5 = require('./md5.min.js');
var getSource = function() {
  let source = 'other';
  if (window) {
    let href = window.location.href;
    href = 'market.ppkao.com';
    if (href.search(/h5.ppkao.com/) > -1) {
      source = href.search(/v2/) > -1 ? 'H5v2' : 'H5';
    } else if (href.search(/[u|market|dls].ppkao.com/) > -1) {
      source = 'api_pc';
    }
  }
  return source;
};
var SortUrl = function(url, reg) {
  if (url.search(/source/gi) === -1) {
    url += `&source=${getSource()}`;
  }
  if (reg) {
    url = url.replace(/data.api.ppkao/, 'api.ppkao').replace(/\?&/, '?');
  } else {
    url = url
      .replace(/\s+/g, '')
      .replace(/data.api.ppkao/, 'api.ppkao')
      .replace(/\?&/, '?');
  }
  var arr = url.substring(url.lastIndexOf('?') + 1, url.length).split('&');

  var len = arr.length;
  for (var i = 0; i < len; i++) {
    if (!arr[i].split('=')[1]) {
      arr.splice(i, 1);
      i = i - 1;
      len = len - 1;
    }
  }
  arr.sort();

  var str = '';
  for (var i = 0; i < arr.length; i++) {
    str += arr[i];
  }
  url = `${url}&sign=${md5(urldecode(str, 'gbk'))}`;
  // console.log(arr, '排序结果',url)
  return url;
};
export default SortUrl;
